{"description_en":"# Portal in portal\n\nJust this, solved analytically.\n\nI posted [video](https://www.youtube.com/watch?v=fWkAfa96OmI) about this a long time ago, but I solved this problem using complicated algorithms with polygons, and this has many many bugs.\n\nBut this time I approach this problem completely different, and because of this, this demo can be run in browser without any additional complicated code.","description_ru":"","cam":{"look_at":[0.07,0.15,0.12],"alpha":-30.757742,"beta":1.1458437,"r":1.7960409,"offset_after_material":0.000003},"uniforms":{"names":["room_size_x","room_size_x_minus","room_size_y","room_size_y_minus","room_size_z","room_size_z_minus","teleport_light"],"storage":[{"Float":{"min":0.0,"max":null,"value":4.0}},{"Formula":"-room_size_x"},{"Float":{"min":0.0,"max":null,"value":4.0}},{"Formula":"-room_size_y"},{"Float":{"min":0.0,"max":null,"value":4.0}},{"Formula":"-room_size_z"},{"Bool":true}]},"matrices":{"names":["id","room_origin","rx1","rx2","ry1","ry2","rz1","rz2","mrx1","mrx2","mry1","mry2","mrz1","mrz2","a","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","b10"],"storage":[{"Simple":{"offset":[0.0,0.0,0.0],"scale":1.0,"rotate":[0.0,0.0,0.0],"mirror":[false,false,false]}},{"Simple":{"offset":[0.0,0.0,0.0],"scale":1.0,"rotate":[0.0,0.0,0.0],"mirror":[false,false,false]}},{"Parametrized":{"offset":{"x":{"Yes":"room_size_x"},"y":{"No":0.0},"z":{"No":0.0}},"rotate":{"x":{"No":0.0},"y":{"No":1.5707964},"z":{"No":0.0}},"mirror":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"scale":{"No":1.0}}},{"Parametrized":{"offset":{"x":{"Yes":"room_size_x_minus"},"y":{"No":0.0},"z":{"No":0.0}},"rotate":{"x":{"No":0.0},"y":{"No":1.5707964},"z":{"No":0.0}},"mirror":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"scale":{"No":1.0}}},{"Parametrized":{"offset":{"x":{"No":0.0},"y":{"Yes":"room_size_y"},"z":{"No":0.0}},"rotate":{"x":{"No":1.5707964},"y":{"No":0.0},"z":{"No":0.0}},"mirror":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"scale":{"No":1.0}}},{"Parametrized":{"offset":{"x":{"No":0.0},"y":{"Yes":"room_size_y_minus"},"z":{"No":0.0}},"rotate":{"x":{"No":1.5707964},"y":{"No":0.0},"z":{"No":0.0}},"mirror":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"scale":{"No":1.0}}},{"Parametrized":{"offset":{"x":{"No":0.0},"y":{"No":0.0},"z":{"Yes":"room_size_z"}},"rotate":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"mirror":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"scale":{"No":1.0}}},{"Parametrized":{"offset":{"x":{"No":0.0},"y":{"No":0.0},"z":{"Yes":"room_size_z_minus"}},"rotate":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"mirror":{"x":{"No":0.0},"y":{"No":0.0},"z":{"No":0.0}},"scale":{"No":1.0}}},{"Mul":{"to":"rx1","what":"room_origin"}},{"Mul":{"to":"rx2","what":"room_origin"}},{"Mul":{"to":"ry1","what":"room_origin"}},{"Mul":{"to":"ry2","what":"room_origin"}},{"Mul":{"to":"rz1","what":"room_origin"}},{"Mul":{"to":"rz2","what":"room_origin"}},{"Simple":{"offset":[0.0,0.0,0.0],"scale":1.0,"rotate":[0.0,0.0,0.0],"mirror":[false,false,false]}},{"Simple":{"offset":[0.0,0.0,0.28],"scale":1.0,"rotate":[0.0,4.712389,1.5707964],"mirror":[false,false,false]}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b0"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b1"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b2"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b3"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b4"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b5"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b6"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b7"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b8"}},{"Teleport":{"first_portal":"a","second_portal":"b0","what":"b9"}}]},"objects":{"names":["rx1","rx2","ry1","ry2","rz1","rz2","portal0","portal1","portal2","portal3","portal4","portal5","portal6","portal7","portal8","portal9","portal10"],"storage":[{"Flat":{"kind":{"Simple":"mrx1"},"is_inside":"return is_inside_square(x, y, room_size_z_u, room_size_y_u, room_yellow_M);"}},{"Flat":{"kind":{"Simple":"mrx2"},"is_inside":"return is_inside_square(x, y, room_size_z_u, room_size_y_u, room_red_M);"}},{"Flat":{"kind":{"Simple":"mry1"},"is_inside":"return is_inside_square(x, y, room_size_x_u, room_size_z_u, room_black_M);"}},{"Flat":{"kind":{"Simple":"mry2"},"is_inside":"return is_inside_square(x, y, room_size_x_u, room_size_z_u, room_gray_M);"}},{"Flat":{"kind":{"Simple":"mrz1"},"is_inside":"return is_inside_square(x, y, room_size_x_u, room_size_y_u, room_blue_M);"}},{"Flat":{"kind":{"Simple":"mrz2"},"is_inside":"return is_inside_square(x, y, room_size_x_u, room_size_y_u, room_green_M);"}},{"Flat":{"kind":{"Portal":["a","b0"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b0_mat_teleport * pos; }\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_0_M);"}},{"Flat":{"kind":{"Portal":["a","b1"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b1_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_1_M);"}},{"Flat":{"kind":{"Portal":["a","b2"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b2_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_2_M);"}},{"Flat":{"kind":{"Portal":["a","b3"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b3_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_3_M);"}},{"Flat":{"kind":{"Portal":["a","b4"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b4_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b3_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_4_M);"}},{"Flat":{"kind":{"Portal":["a","b5"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b5_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b3_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b4_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_5_M);"}},{"Flat":{"kind":{"Portal":["a","b6"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b6_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b3_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b4_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b5_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_6_M);"}},{"Flat":{"kind":{"Portal":["a","b7"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b7_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b3_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b4_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b5_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b6_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_7_M);"}},{"Flat":{"kind":{"Portal":["a","b8"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b8_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b3_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b4_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b5_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b6_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b7_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_8_M);"}},{"Flat":{"kind":{"Portal":["a","b9"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b9_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b3_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b4_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b5_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b6_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b7_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b8_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_9_M);"}},{"Flat":{"kind":{"Portal":["a","b10"]},"is_inside":"if (definitely_not_in_portal(x, y)) return NOT_INSIDE;\n\nvec4 pos1 = pos;\nif (first) { pos1 = a_to_b10_mat_teleport * pos; }\n\nif ((b0_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b1_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b2_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b3_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b4_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b5_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b6_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b7_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b8_mat_inv * pos1).z > 0.) return NOT_INSIDE;\nif ((b9_mat_inv * pos1).z > 0.) return NOT_INSIDE;\n\nif ((a_mat_inv * pos1).z < 0.) return NOT_INSIDE;\n\nreturn ellipse_portal(x, y, back, first, solid_10_M);"}}]},"textures":{"names":[],"storage":[]},"materials":{"names":["room_green","room_red","room_gray","room_black","room_blue","room_yellow","portal_orange","portal_blue","solid_0","solid_1","solid_2","solid_3","solid_4","solid_5","solid_6","solid_7","solid_8","solid_9","solid_10"],"storage":[{"Simple":{"color":[0.15478948,0.73873776,0.2186588],"normal_coef":0.5,"grid":true,"grid_scale":1.0,"grid_coef":0.3}},{"Simple":{"color":[0.8458183,0.07454156,0.07454156],"normal_coef":0.5,"grid":true,"grid_scale":1.0,"grid_coef":0.3}},{"Simple":{"color":[0.18068509,0.18068509,0.18068509],"normal_coef":0.5,"grid":true,"grid_scale":1.0,"grid_coef":0.3}},{"Simple":{"color":[0.029196177,0.029196177,0.029196177],"normal_coef":0.5,"grid":true,"grid_scale":1.0,"grid_coef":0.3}},{"Simple":{"color":[0.116810285,0.26798066,0.9083436],"normal_coef":0.5,"grid":true,"grid_scale":1.0,"grid_coef":0.2}},{"Simple":{"color":[0.7647179,0.7024815,0.061205085],"normal_coef":0.5,"grid":true,"grid_scale":1.0,"grid_coef":0.3}},{"Complex":{"code":"MaterialProcessing result = material_simple(hit, r, vec3(0.6495146,0.2954198,0.03270938), 5e-1, false, 4e0, 3e-1);\nreturn result;"}},{"Complex":{"code":"MaterialProcessing result = material_simple(hit, r, vec3(0.04732297,0.560074,0.68341726), 5e-1, false, 4e0, 3e-1);\nreturn result;"}},{"Simple":{"color":[1.0,0.24376154,0.24376154],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[0.24376106,1.0,0.25302637],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[0.18710661,0.19761491,1.0],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[1.0,0.97995126,0.15473223],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[0.7078609,0.20059586,1.0],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[1.0,0.18440866,0.66435695],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[1.0,0.51893616,0.08458853],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[0.28545788,0.9856131,0.73604244],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[0.5713339,0.5713339,0.5713339],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[0.15266089,0.15266089,0.15266089],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}},{"Simple":{"color":[0.013828539,0.013455469,0.013455469],"normal_coef":0.5,"grid":true,"grid_scale":10.0,"grid_coef":0.5}}]},"library":{"names":["room","portal"],"storage":["int is_inside_square(float x, float y, float sizex, float sizey, int material) {\n  if (abs(x) < sizex && abs(y) < sizey) {\n    return material;\n  } else {\n    return NOT_INSIDE;\n  }\n}\n","int ellipse_portal(float x, float y, bool back, bool first, int not_teleport_material) {\nint material = portal_blue_M;\nif (first) material = portal_orange_M;\n\nif (2.*x*x + y*y < 1.) {\n  if (back) {\n    if (teleport_light_u == 1) {\n      return material;\n    } else {\n      return not_teleport_material;\n    }\n  } else {\n    if (teleport_light_u == 1) {\n      return TELEPORT;\n    } else {\n      return not_teleport_material;\n    }\n  }\n} else if (2.*x*x + y*y < 1.1) {\n  return material;\n} else {\n  return NOT_INSIDE;\n}\n}\n\nbool definitely_not_in_portal(float x, float y) {\n  return !(abs(x) < 2.2 && abs(y) < 2.2);\n}"]},"user_uniforms":{"uniforms":[false,false,false,false,false,false,true],"matrices":[false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,true,false,false,false,false,false,false,false,false,false,false]},"animation_stages":{"names":[],"storage":[]},"current_stage":5}